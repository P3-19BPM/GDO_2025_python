<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Dados de Crimes</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca SheetJS para ler arquivos Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        /* Estilo para animação de fade-in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilo para o loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Painel de Análise de Ocorrências</h1>
            <p class="text-gray-600 mt-1">Carregue seu arquivo Excel (.xlsx) para iniciar a análise.</p>
        </header>

        <!-- Seção de Upload de Arquivos -->
        <div id="upload-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Carregar Arquivo de Dados</h2>
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label for="excel-file" class="block text-sm font-medium text-gray-700 mb-1">Arquivo Excel (ex:
                        Interacao_Dados.xlsx)</label>
                    <input type="file" id="excel-file" accept=".xlsx, .xls"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            </div>
            <div class="mt-6 flex items-center gap-4">
                <button id="process-button"
                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                    Processar Dados
                </button>
                <div id="loader" class="loader hidden"></div>
            </div>
            <div id="error-message" class="text-red-600 mt-4 font-medium hidden"></div>
        </div>

        <!-- Seção Principal de Análise (inicialmente oculta) -->
        <main id="analysis-section" class="hidden">
            <!-- Seção do Dashboard de Estatísticas -->
            <div id="dashboard-section" class="mb-8 fade-in">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Resumo das Visitas</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-red-400 text-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-semibold text-lg">Total de Crimes</h3>
                        <p id="total-crimes" class="text-4xl font-bold mt-2">0</p>
                    </div>
                    <div class="bg-gray-300 text-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="font-semibold text-lg">Sem Visitas</h3>
                        <p id="no-visits" class="text-4xl font-bold mt-2">0</p>
                    </div>
                    <div class="bg-green-300 text-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="font-semibold text-lg">Com 1 Visita</h3>
                        <p id="one-visit" class="text-4xl font-bold mt-2">0</p>
                    </div>
                    <div class="bg-green-600 text-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-semibold text-lg">Com 2 ou Mais Visitas</h3>
                        <p id="two-plus-visits" class="text-4xl font-bold mt-2">0</p>
                    </div>
                </div>
            </div>

            <!-- Seção de Consulta de Ocorrências -->
            <div id="lookup-section" class="bg-white p-6 rounded-xl shadow-md fade-in">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">3. Consultar Detalhes da Ocorrência</h2>
                <div>
                    <label for="occurrence-select" class="block text-sm font-medium text-gray-700 mb-1">Selecione o
                        Número da Ocorrência:</label>
                    <select id="occurrence-select"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option>Selecione uma ocorrência</option>
                    </select>
                </div>

                <div id="results-area" class="mt-6 overflow-x-auto">
                    <!-- Os resultados da consulta serão inseridos aqui -->
                </div>
            </div>
        </main>

    </div>

    <script>
        // --- Elementos da UI ---
        const excelFileInput = document.getElementById('excel-file');
        const processButton = document.getElementById('process-button');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const analysisSection = document.getElementById('analysis-section');
        const occurrenceSelect = document.getElementById('occurrence-select');
        const resultsArea = document.getElementById('results-area');

        // --- Armazenamento de dados ---
        let crimeData = [];
        let visitaData = [];
        const palavrasExcluidas = ['autor', 'suspeito', 'co-autor'];

        // --- Funções Auxiliares ---

        /**
         * Realiza a análise dos dados e atualiza o dashboard.
         */
        function processAndAnalyzeData() {
            // 1. Obter ocorrências únicas da VT_CRIME
            // Garante que todos os valores sejam tratados como string para a unicidade
            const uniqueOccurrences = [...new Set(crimeData.map(crime => String(crime.numero_ocorrencia)))];
            const totalCrimes = uniqueOccurrences.length;
            document.getElementById('total-crimes').textContent = totalCrimes;

            // 2. Contar visitas por ocorrência
            const visitCounts = {};
            visitaData.forEach(visita => {
                const crimeId = String(visita.numero_reds_furto); // Garante a consistência do tipo
                if (crimeId) {
                    visitCounts[crimeId] = (visitCounts[crimeId] || 0) + 1;
                }
            });

            // 3. Categorizar crimes baseados na contagem de visitas
            let noVisits = 0;
            let oneVisit = 0;
            let twoPlusVisits = 0;

            uniqueOccurrences.forEach(occurrenceId => {
                const count = visitCounts[occurrenceId] || 0;
                if (count === 0) {
                    noVisits++;
                } else if (count === 1) {
                    oneVisit++;
                } else {
                    twoPlusVisits++;
                }
            });

            // 4. Atualizar a UI do Dashboard
            document.getElementById('no-visits').textContent = noVisits;
            document.getElementById('one-visit').textContent = oneVisit;
            document.getElementById('two-plus-visits').textContent = twoPlusVisits;

            // 5. Popular o menu suspenso de ocorrências
            populateOccurrenceDropdown(uniqueOccurrences);
        }

        /**
         * Popula o menu suspenso com as ocorrências únicas.
         * @param {Array<string>} occurrences - Array de números de ocorrência únicos.
         */
        function populateOccurrenceDropdown(occurrences) {
            occurrenceSelect.innerHTML = '<option value="">-- Selecione uma ocorrência --</option>'; // Limpa e adiciona a opção padrão
            occurrences.sort().forEach(occ => {
                const option = document.createElement('option');
                option.value = occ;
                option.textContent = occ;
                occurrenceSelect.appendChild(option);
            });
        }

        /**
         * Exibe os detalhes de uma ocorrência selecionada.
         */
        function displayOccurrenceDetails() {
            const selectedOccurrence = occurrenceSelect.value;
            resultsArea.innerHTML = ''; // Limpa resultados anteriores

            if (!selectedOccurrence) {
                return;
            }

            // Filtra os envolvidos para a ocorrência selecionada
            const relatedPeople = crimeData
                .filter(record => String(record.numero_ocorrencia) === selectedOccurrence)
                .filter(record => {
                    const involvement = String(record.envolvimento_descricao || '').toLowerCase();
                    // Verifica se a descrição do envolvimento NÃO contém nenhuma das palavras excluídas
                    return !palavrasExcluidas.some(palavra => involvement.includes(palavra));
                });

            // Cria e exibe a tabela de resultados
            if (relatedPeople.length > 0) {
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200 mt-4';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome Completo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Envolvimento</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${relatedPeople.map(person => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${person.nome_completo_envolvido || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${person.numero_telefone_residencial || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${person.envolvimento_descricao || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                resultsArea.appendChild(table);
            } else {
                resultsArea.innerHTML = `<p class="text-gray-600 mt-4 p-4 bg-yellow-50 rounded-md">Nenhum envolvido (que não seja autor/suspeito) encontrado para esta ocorrência.</p>`;
            }
        }

        // --- Event Listeners ---

        /**
         * Manipulador do clique no botão "Processar Dados".
         */
        processButton.addEventListener('click', () => {
            const file = excelFileInput.files[0];

            if (!file) {
                errorMessage.textContent = "Por favor, selecione o arquivo Excel.";
                errorMessage.classList.remove('hidden');
                return;
            }

            loader.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            processButton.disabled = true;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Verificar se as abas existem
                    const crimeSheetName = "VT_CRIME";
                    const visitaSheetName = "VT_VISITA";

                    if (!workbook.SheetNames.includes(crimeSheetName) || !workbook.SheetNames.includes(visitaSheetName)) {
                        throw new Error(`O arquivo Excel deve conter as abas "${crimeSheetName}" e "${visitaSheetName}".`);
                    }

                    // Converter abas para JSON
                    const crimeSheet = workbook.Sheets[crimeSheetName];
                    const visitaSheet = workbook.Sheets[visitaSheetName];
                    crimeData = XLSX.utils.sheet_to_json(crimeSheet);
                    visitaData = XLSX.utils.sheet_to_json(visitaSheet);

                    if (crimeData.length === 0) {
                        throw new Error(`A aba "${crimeSheetName}" está vazia ou em formato incorreto.`);
                    }

                    // Validar colunas
                    const requiredCrimeCols = ['numero_ocorrencia', 'nome_completo_envolvido', 'numero_telefone_residencial', 'envolvimento_descricao'];
                    const requiredVisitaCols = ['numero_reds_furto'];
                    const crimeHeader = Object.keys(crimeData[0]);
                    // A aba visita pode estar vazia, então só validamos se houver dados
                    const visitaHeader = visitaData.length > 0 ? Object.keys(visitaData[0]) : requiredVisitaCols;

                    const missingCrimeCols = requiredCrimeCols.filter(col => !crimeHeader.includes(col));
                    const missingVisitaCols = requiredVisitaCols.filter(col => !visitaHeader.includes(col));

                    if (missingCrimeCols.length > 0 || missingVisitaCols.length > 0) {
                        let errorMsg = "Colunas obrigatórias não encontradas. ";
                        if (missingCrimeCols.length > 0) errorMsg += `Faltando em VT_CRIME: [${missingCrimeCols.join(', ')}]. `;
                        if (missingVisitaCols.length > 0) errorMsg += `Faltando em VT_VISITA: [${missingVisitaCols.join(', ')}].`;
                        throw new Error(errorMsg);
                    }

                    processAndAnalyzeData();
                    analysisSection.classList.remove('hidden');

                } catch (error) {
                    errorMessage.textContent = `Erro ao processar arquivo: ${error.message}`;
                    errorMessage.classList.remove('hidden');
                    analysisSection.classList.add('hidden');
                } finally {
                    loader.classList.add('hidden');
                    processButton.disabled = false;
                }
            };

            reader.onerror = () => {
                errorMessage.textContent = 'Ocorreu um erro ao tentar ler o arquivo.';
                errorMessage.classList.remove('hidden');
                loader.classList.add('hidden');
                processButton.disabled = false;
            };

            reader.readAsArrayBuffer(file);
        });

        /**
         * Manipulador de mudança no menu de seleção de ocorrência.
         */
        occurrenceSelect.addEventListener('change', displayOccurrenceDetails);

    </script>
</body>

</html>