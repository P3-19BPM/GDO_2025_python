<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Dados de Crimes</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Turf.js (Geoanálise) -->
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <!-- Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        // ATENÇÃO: Substitua o objeto abaixo pela configuração do SEU projeto Firebase.
        // Você pode encontrar isso no console do Firebase > Configurações do Projeto.
        const firebaseConfig = {
            apiKey: "AIzaSyCQeD0V91NbUjuhg7-6BRwNOIjw_mdkL24",
            authDomain: "vtcrime-d6a61.firebaseapp.com",
            projectId: "vtcrime-d6a61",
            storageBucket: "vtcrime-d6a61.firebasestorage.app",
            messagingSenderId: "261046458856",
            appId: "1:261046458856:web:3226ca9b456619c85cac5d",
            measurementId: "G-WHMFBTJV60"
        };

        // VERIFICAÇÃO DE SEGURANÇA: Checa se a chave de API foi alterada.
        if (firebaseConfig.apiKey === "COLE_SUA_API_KEY_AQUI") {
            // Esconde a tela de login normal para não confundir.
            const loginBox = document.getElementById('login-box');
            if (loginBox) loginBox.style.display = 'none';

            // Mostra um erro claro para o usuário.
            const configError = document.getElementById('config-error');
            if (configError) configError.classList.remove('hidden');

            // Interrompe a execução para evitar mais erros do Firebase.
            throw new Error("CONFIGURAÇÃO DO FIREBASE INCOMPLETA: É necessário preencher o objeto 'firebaseConfig' com as chaves do seu projeto.");
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Expondo as funções para o escopo global para que os botões possam chamá-las
        window.authFunctions = {
            signInWithGoogle: () => {
                signInWithPopup(auth, provider)
                    .catch((error) => {
                        console.error("Erro no login com Google:", error);
                        alert(`Erro no login: ${error.message}`);
                    });
            },
            signOutUser: () => {
                signOut(auth).catch((error) => console.error("Erro no logout:", error));
            }
        };

        // Monitora o estado da autenticação
        onAuthStateChanged(auth, (user) => {
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const userInfo = document.getElementById('user-info');

            if (user) {
                // Usuário está logado
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                userInfo.innerHTML = `
                    <span class="text-sm text-gray-600">Logado como: <strong>${user.displayName || user.email}</strong></span>
                    <button onclick="window.authFunctions.signOutUser()" class="ml-4 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-red-600">Sair</button>
                `;

                // Dispara um evento para notificar que o app pode inicializar
                window.dispatchEvent(new CustomEvent('user-authenticated'));

            } else {
                // Usuário não está logado
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
    </script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .geo-filters-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        .leaflet-container {
            background: #fff;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <!-- Tela de Login -->
    <div id="login-container" class="flex items-center justify-center h-screen">
        <div class="text-center bg-white p-10 rounded-xl shadow-lg">
            <!-- Mensagem de Erro de Configuração -->
            <div id="config-error" class="hidden mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4"
                role="alert">
                <p class="font-bold">Ação Necessária</p>
                <p>A configuração do Firebase está incompleta. Por favor, edite o código HTML e insira as chaves do seu
                    projeto Firebase na variável <code>firebaseConfig</code>.</p>
            </div>

            <!-- Caixa de Login Padrão -->
            <div id="login-box">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Painel de Análise Criminal</h1>
                <p class="text-gray-600 mb-6">Por favor, faça login para continuar.</p>
                <button onclick="window.authFunctions.signInWithGoogle()"
                    class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 flex items-center mx-auto">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#FFC107"
                            d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z" />
                        <path fill="#FF3D00"
                            d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z" />
                        <path fill="#4CAF50"
                            d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.519-3.357-11.181-7.944l-6.573 4.818C9.231 39.752 16.041 44 24 44z" />
                        <path fill="#1976D2"
                            d="M43.611 20.083H42V20H24v8h11.303c-.792 2.447-2.274 4.481-4.244 5.86l6.19 5.238C39.999 36.697 44 31.134 44 24c0-1.341-.138-2.65-.389-3.917z" />
                    </svg>
                    Entrar com Google
                </button>
            </div>
        </div>
    </div>


    <!-- Conteúdo Principal do Aplicativo -->
    <div id="app-container" class="hidden">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Painel de Análise de Ocorrências</h1>
                <div id="user-info" class="text-right"></div>
            </header>

            <!-- Seção de Upload -->
            <div id="upload-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <div id="upload-inputs">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Carregar Arquivos</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div><label for="excel-file" class="block text-sm font-medium text-gray-700 mb-1">Arquivo Excel
                                (VT_CRIME e VT_VISITA)</label><input type="file" id="excel-file" accept=".xlsx, .xls"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div><label for="geojson-file" class="block text-sm font-medium text-gray-700 mb-1">Arquivo de
                                Setores (GeoJSON)</label><input type="file" id="geojson-file" accept=".geojson"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                        </div>
                    </div>
                    <div class="mt-6"><button id="process-button"
                            class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Processar e
                            Analisar</button></div>
                </div>
                <div id="loaded-data-info" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Dados Carregados</h2>
                    <p class="text-gray-600">Continuando com os arquivos salvos:</p>
                    <ul class="list-disc list-inside my-2 text-gray-800">
                        <li id="loaded-excel-filename"></li>
                        <li id="loaded-geojson-filename" class="hidden"></li>
                    </ul>
                    <button id="clear-data-button"
                        class="mt-4 bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Limpar Dados
                        e Carregar Novos</button>
                </div>
                <div class="mt-4 flex items-center gap-4">
                    <div id="loader" class="loader hidden"></div>
                    <div id="error-message" class="text-red-600 font-medium hidden"></div>
                </div>
            </div>

            <!-- Seção Principal de Análise -->
            <main id="analysis-section" class="hidden">
                <!-- Filtros -->
                <div id="filter-section" class="bg-white p-6 rounded-xl shadow-md mb-8 fade-in">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Filtros de Análise</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                        <div><label for="municipio-filter"
                                class="block text-sm font-medium text-gray-700">Município</label><select
                                id="municipio-filter"
                                class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select></div>
                        <div><label for="start-date-filter" class="block text-sm font-medium text-gray-700">Data
                                Início</label><input type="date" id="start-date-filter"
                                class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label for="end-date-filter" class="block text-sm font-medium text-gray-700">Data
                                Fim</label><input type="date" id="end-date-filter"
                                class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div id="geo-filters" class="contents geo-filters-disabled">
                            <div><label for="cia-filter" class="block text-sm font-medium text-gray-700">CIA
                                    PM</label><select id="cia-filter"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select></div>
                            <div><label for="pel-filter"
                                    class="block text-sm font-medium text-gray-700">Pelotão</label><select
                                    id="pel-filter"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select></div>
                            <div><label for="subsetor-filter" class="block text-sm font-medium text-gray-700">Sub
                                    Setor</label><select id="subsetor-filter"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select></div>
                        </div>
                    </div>
                    <div class="mt-4"><button id="apply-filters-button"
                            class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Aplicar
                            Filtros</button></div>
                </div>

                <!-- Mapa e Dashboard -->
                <div class="grid lg:grid-cols-3 gap-8 mb-8 fade-in">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">3. Mapa de Ocorrências</h2>
                        <div id="map" style="height: 500px;" class="rounded-lg z-0"></div>
                    </div>
                    <div id="dashboard-section" class="lg:col-span-1">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">4. Resumo das Visitas</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6">
                            <div class="bg-red-400 text-white p-6 rounded-xl shadow-lg">
                                <h3>Total de Crimes</h3>
                                <p id="total-crimes" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <div class="bg-gray-300 text-gray-800 p-6 rounded-xl shadow-lg">
                                <h3>Sem Visitas</h3>
                                <p id="no-visits" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <div class="bg-green-300 text-gray-800 p-6 rounded-xl shadow-lg">
                                <h3>Com 1 Visita</h3>
                                <p id="one-visit" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <div class="bg-green-600 text-white p-6 rounded-xl shadow-lg">
                                <h3>Com 2+ Visitas</h3>
                                <p id="two-plus-visits" class="text-4xl font-bold mt-2">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consulta de Ocorrências -->
                <div id="lookup-section" class="bg-white p-6 rounded-xl shadow-md fade-in">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">5. Consultar Detalhes da Ocorrência</h2>
                    <div><label for="occurrence-select" class="block text-sm font-medium text-gray-700">Selecione a
                            Ocorrência:</label><select id="occurrence-select"
                            class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select></div>
                    <div id="results-area" class="mt-6 overflow-x-auto"></div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        // Este script depende do módulo Firebase carregado no <head>
    </script>

    <script>
        // --- Elementos da UI ---
        const ui = {
            excelFile: document.getElementById('excel-file'), geojsonFile: document.getElementById('geojson-file'), processBtn: document.getElementById('process-button'), applyFiltersBtn: document.getElementById('apply-filters-button'), clearDataBtn: document.getElementById('clear-data-button'), loader: document.getElementById('loader'), errorMsg: document.getElementById('error-message'), analysisSection: document.getElementById('analysis-section'), occurrenceSelect: document.getElementById('occurrence-select'), resultsArea: document.getElementById('results-area'), uploadInputs: document.getElementById('upload-inputs'), loadedDataInfo: document.getElementById('loaded-data-info'),
            filters: { municipio: document.getElementById('municipio-filter'), startDate: document.getElementById('start-date-filter'), endDate: document.getElementById('end-date-filter'), cia: document.getElementById('cia-filter'), pel: document.getElementById('pel-filter'), subsetor: document.getElementById('subsetor-filter'), },
            geoFiltersContainer: document.getElementById('geo-filters'), map: document.getElementById('map'),
        };

        let state = { allCrimeData: [], allVisitaData: [], filteredCrimeData: [], geojsonData: null, map: null, crimeMarkersLayer: null, sectorLayer: null };
        const palavrasExcluidas = ['autor', 'suspeito', 'co-autor'];

        const db = {
            DB_NAME: 'CrimeAnalysisDB_v4', STORE_NAME: 'FileStore',
            open() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.DB_NAME, 1);
                    req.onerror = () => reject("Erro DB"); req.onsuccess = () => resolve(req.result); req.onupgradeneeded = e => e.target.result.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
                });
            },
            async set(id, value) { const db = await this.open(); return new Promise((resolve, reject) => { const tx = db.transaction([this.STORE_NAME], 'readwrite'); tx.objectStore(this.STORE_NAME).put({ id, value }); tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error); }); },
            async get(id) { const db = await this.open(); return new Promise((resolve, reject) => { const req = db.transaction([this.STORE_NAME]).objectStore(this.STORE_NAME).get(id); req.onsuccess = () => resolve(req.result ? req.result.value : null); req.onerror = () => reject(req.error); }); },
            async clear() { const db = await this.open(); return new Promise((resolve, reject) => { const tx = db.transaction([this.STORE_NAME], 'readwrite'); tx.objectStore(this.STORE_NAME).clear(); tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error); }); }
        };

        async function initializeApp() {
            showLoader(true);
            try {
                const savedCrimeData = await db.get('crimeData');
                if (savedCrimeData && savedCrimeData.length > 0) {
                    state.allCrimeData = savedCrimeData;
                    state.allVisitaData = await db.get('visitaData');
                    state.geojsonData = await db.get('geojsonData');
                    const excelFileName = await db.get('excelFileName') || 'Arquivo salvo';
                    const geojsonFileName = await db.get('geojsonFileName');
                    document.getElementById('loaded-excel-filename').textContent = `Excel: ${excelFileName}`;
                    if (geojsonFileName) {
                        const geoLi = document.getElementById('loaded-geojson-filename');
                        geoLi.textContent = `GeoJSON: ${geojsonFileName}`;
                        geoLi.classList.remove('hidden');
                    }
                    ui.uploadInputs.classList.add('hidden');
                    ui.loadedDataInfo.classList.remove('hidden');
                    initMap();
                    runFullAnalysis();
                    ui.analysisSection.classList.remove('hidden');
                }
            } catch (error) { showError("Não foi possível carregar dados salvos. Por favor, carregue os arquivos novamente."); console.error("Erro IndexedDB:", error); } finally { showLoader(false); }
        }

        function initMap() {
            if (state.map) { state.map.invalidateSize(); return; }
            state.map = L.map(ui.map).setView([-18.22, -41.50], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(state.map);
            state.crimeMarkersLayer = L.layerGroup().addTo(state.map);
        }

        async function processFilesAndAnalyze() {
            const excelFile = ui.excelFile.files[0];
            if (!excelFile) return showError("Por favor, selecione o arquivo Excel.");
            showLoader(true);
            try {
                const workbook = await readExcelFile(excelFile);
                validateAndLoadExcelData(workbook);
                if (ui.geojsonFile.files[0]) {
                    const geojsonText = await ui.geojsonFile.files[0].text();
                    state.geojsonData = JSON.parse(geojsonText);
                    tagCrimesWithGeoData();
                } else { state.geojsonData = null; }
                await saveAllDataToDB(excelFile.name, ui.geojsonFile.files[0]?.name);
                initMap();
                runFullAnalysis();
                ui.analysisSection.classList.remove('hidden');
                ui.uploadInputs.classList.add('hidden');
                ui.loadedDataInfo.classList.remove('hidden');
                document.getElementById('loaded-excel-filename').textContent = `Excel: ${excelFile.name}`;
                if (ui.geojsonFile.files[0]) {
                    document.getElementById('loaded-geojson-filename').textContent = `GeoJSON: ${ui.geojsonFile.files[0].name}`;
                    document.getElementById('loaded-geojson-filename').classList.remove('hidden');
                }
            } catch (error) { showError(`Erro ao processar: ${error.message}`); ui.analysisSection.classList.add('hidden'); } finally { showLoader(false); }
        }

        function runFullAnalysis() {
            if (state.geojsonData) { ui.geoFiltersContainer.classList.remove('geo-filters-disabled'); }
            populateAllFilters(); applyFiltersAndRedraw();
        }

        function readExcelFile(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve(XLSX.read(new Uint8Array(e.target.result), { type: 'array' })); reader.onerror = () => reject(new Error("Erro ao ler arquivo.")); reader.readAsArrayBuffer(file); }); }

        function validateAndLoadExcelData(workbook) {
            const crimeSheetName = "VT_CRIME", visitaSheetName = "VT_VISITA";
            if (!workbook.SheetNames.includes(crimeSheetName) || !workbook.SheetNames.includes(visitaSheetName)) throw new Error(`Abas "${crimeSheetName}" e "${visitaSheetName}" não encontradas.`);
            state.allCrimeData = XLSX.utils.sheet_to_json(workbook.Sheets[crimeSheetName]);
            state.allVisitaData = XLSX.utils.sheet_to_json(workbook.Sheets[visitaSheetName]);
            if (state.allCrimeData.length === 0) throw new Error(`Aba "${crimeSheetName}" está vazia.`);
            const required = ['numero_ocorrencia', 'nome_municipio', 'data_hora_fato', 'numero_latitude', 'numero_longitude'];
            const missing = required.filter(col => !Object.keys(state.allCrimeData[0]).includes(col));
            if (missing.length > 0) throw new Error(`Faltando colunas em VT_CRIME: [${missing.join(', ')}]`);
        }

        async function saveAllDataToDB(excelFileName, geojsonFileName) { await Promise.all([db.set('crimeData', state.allCrimeData), db.set('visitaData', state.allVisitaData), db.set('geojsonData', state.geojsonData), db.set('excelFileName', excelFileName), db.set('geojsonFileName', geojsonFileName || null)]); }

        function applyFiltersAndRedraw() {
            let data = [...state.allCrimeData];
            const municipio = ui.filters.municipio.value; if (municipio) data = data.filter(c => c.nome_municipio === municipio);
            const startDate = ui.filters.startDate.valueAsDate, endDate = ui.filters.endDate.valueAsDate;
            if (startDate || endDate) {
                data = data.filter(c => {
                    const crimeDate = parseExcelDate(c.data_hora_fato);
                    if (!crimeDate) return false;
                    if (startDate && crimeDate < startDate) return false;
                    if (endDate) { const endOfDay = new Date(endDate); endOfDay.setHours(23, 59, 59, 999); if (crimeDate > endOfDay) return false; }
                    return true;
                });
            }
            const cia = ui.filters.cia.value; if (cia) data = data.filter(c => c.CIA_PM == cia);
            const pel = ui.filters.pel.value; if (pel) data = data.filter(c => c.PELOTAO == pel);
            const subsetor = ui.filters.subsetor.value; if (subsetor) data = data.filter(c => c.SUB_SETOR == subsetor);
            state.filteredCrimeData = data;
            updateDashboard(data, state.allVisitaData); populateOccurrenceDropdown(data); updateMapLayers();
        }

        function populateAllFilters() {
            const populateSelect = (el, values, keep) => {
                const current = keep ? el.value : null;
                const unique = [...new Set(values)].filter(v => v).sort();
                el.innerHTML = '<option value="">Todos</option>';
                unique.forEach(v => { el.innerHTML += `<option value="${v}" ${current == v ? 'selected' : ''}>${v}</option>`; });
            };
            populateSelect(ui.filters.municipio, state.allCrimeData.map(c => c.nome_municipio), true);
            if (state.geojsonData) {
                const selectedCia = ui.filters.cia.value, selectedPel = ui.filters.pel.value;
                populateSelect(ui.filters.cia, state.allCrimeData.map(c => c.CIA_PM), true);
                const pels = state.allCrimeData.filter(c => !selectedCia || c.CIA_PM == selectedCia).map(c => c.PELOTAO);
                populateSelect(ui.filters.pel, pels, true);
                const subsetores = state.allCrimeData.filter(c => (!selectedCia || c.CIA_PM == selectedCia) && (!selectedPel || c.PELOTAO == selectedPel)).map(c => c.SUB_SETOR);
                populateSelect(ui.filters.subsetor, subsetores, true);
            }
        }

        function updateDashboard(crimes, visitas) {
            const uniqueOccurrences = [...new Set(crimes.map(c => String(c.numero_ocorrencia)))];
            document.getElementById('total-crimes').textContent = uniqueOccurrences.length;
            const visitCounts = visitas.reduce((acc, v) => { const id = String(v.numero_reds_furto); if (id) acc[id] = (acc[id] || 0) + 1; return acc; }, {});
            let counters = { no: 0, one: 0, two: 0 };
            uniqueOccurrences.forEach(id => { const count = visitCounts[id] || 0; if (count === 0) counters.no++; else if (count === 1) counters.one++; else counters.two++; });
            document.getElementById('no-visits').textContent = counters.no;
            document.getElementById('one-visit').textContent = counters.one;
            document.getElementById('two-plus-visits').textContent = counters.two;
        }

        function populateOccurrenceDropdown(crimes) {
            const unique = [...new Set(crimes.map(c => String(c.numero_ocorrencia)))].sort();
            ui.occurrenceSelect.innerHTML = '<option value="">-- Selecione uma ocorrência --</option>';
            unique.forEach(occ => ui.occurrenceSelect.innerHTML += `<option value="${occ}">${occ}</option>`);
            ui.resultsArea.innerHTML = '';
        }

        function displayOccurrenceDetails() {
            const selected = ui.occurrenceSelect.value;
            ui.resultsArea.innerHTML = ''; if (!selected) return;
            const people = state.filteredCrimeData.filter(r => String(r.numero_ocorrencia) === selected).filter(r => !palavrasExcluidas.some(p => String(r.envolvimento_descricao || '').toLowerCase().includes(p)));
            if (people.length > 0) {
                ui.resultsArea.innerHTML = `<table class="min-w-full divide-y divide-gray-200 mt-4"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome Completo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefone</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Envolvimento</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${people.map(p => `<tr><td class="px-6 py-4 text-sm">${p.nome_completo_envolvido || 'N/A'}</td><td class="px-6 py-4 text-sm">${p.numero_telefone_residencial || 'N/A'}</td><td class="px-6 py-4 text-sm">${p.envolvimento_descricao || 'N/A'}</td></tr>`).join('')}</tbody></table>`;
            } else { ui.resultsArea.innerHTML = `<p class="text-gray-600 mt-4 p-4 bg-yellow-50 rounded-md">Nenhum envolvido encontrado.</p>`; }
        }

        function findProperty(props, name) { const key = Object.keys(props).find(k => k.trim().toLowerCase() === name.trim().toLowerCase()); return key ? props[key] : null; }

        function tagCrimesWithGeoData() {
            if (!state.geojsonData) return;
            state.allCrimeData.forEach(crime => {
                const lat = parseFloat(String(crime.numero_latitude).replace(',', '.')), lon = parseFloat(String(crime.numero_longitude).replace(',', '.'));
                if (isNaN(lat) || isNaN(lon)) return;
                const point = turf.point([lon, lat]);
                for (const feature of state.geojsonData.features) {
                    if (turf.booleanPointInPolygon(point, feature)) {
                        crime.CIA_PM = findProperty(feature.properties, 'CIA_PM');
                        crime.PELOTAO = findProperty(feature.properties, 'PELOTAO');
                        crime.SUB_SETOR = findProperty(feature.properties, 'SUB_SETOR');
                        return;
                    }
                }
            });
        }

        function updateMapLayers() {
            if (!state.map) return;
            state.crimeMarkersLayer.clearLayers();
            if (state.sectorLayer) state.map.removeLayer(state.sectorLayer);
            if (state.geojsonData) {
                state.sectorLayer = L.geoJSON(state.geojsonData, {
                    style: { color: "#3b82f6", weight: 2, opacity: 0.7, fillOpacity: 0.1, },
                    onEachFeature: (feature, layer) => {
                        const cia = findProperty(feature.properties, 'CIA_PM'), pel = findProperty(feature.properties, 'PELOTAO'), subsetor = findProperty(feature.properties, 'SUB_SETOR');
                        layer.bindTooltip(`<b>CIA:</b> ${cia}<br><b>Pelotão:</b> ${pel}<br><b>Sub Setor:</b> ${subsetor}`);
                        layer.on('click', () => { ui.filters.cia.value = cia || ''; populateAllFilters(); ui.filters.pel.value = pel || ''; populateAllFilters(); ui.filters.subsetor.value = subsetor || ''; applyFiltersAndRedraw(); });
                    }
                }).addTo(state.map);
            }
            const markers = [];
            state.filteredCrimeData.forEach(crime => {
                const lat = parseFloat(String(crime.numero_latitude).replace(',', '.')), lon = parseFloat(String(crime.numero_longitude).replace(',', '.'));
                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.marker([lat, lon]).bindPopup(`<b>Ocorrência:</b> ${crime.numero_ocorrencia}<br><b>Município:</b> ${crime.nome_municipio}`);
                    state.crimeMarkersLayer.addLayer(marker); markers.push([lat, lon]);
                }
            });
            if (markers.length > 0) { state.map.fitBounds(L.latLngBounds(markers), { padding: [50, 50], maxZoom: 15 }); }
            else if (state.sectorLayer && state.sectorLayer.getBounds().isValid()) { state.map.fitBounds(state.sectorLayer.getBounds()); }
        }

        function parseExcelDate(d) { if (!d) return null; if (typeof d === 'number') return new Date(Math.round((d - 25569) * 86400 * 1000)); const p = String(d).match(/(\d+)/g); return (p && p.length >= 3) ? new Date(p[2], p[1] - 1, p[0]) : new Date(d); }
        function showError(msg) { ui.errorMsg.textContent = msg; ui.errorMsg.classList.remove('hidden'); }
        function showLoader(show) { ui.loader.classList.toggle('hidden', !show); ui.processBtn.disabled = show; }

        // --- Event Listeners ---
        window.addEventListener('user-authenticated', initializeApp);
        ui.processBtn.addEventListener('click', processFilesAndAnalyze);
        ui.applyFiltersBtn.addEventListener('click', applyFiltersAndRedraw);
        ui.clearDataBtn.addEventListener('click', async () => { if (confirm("Tem certeza?")) { await db.clear(); location.reload(); } });
        ui.occurrenceSelect.addEventListener('change', displayOccurrenceDetails);
        ui.filters.cia.addEventListener('change', () => { ui.filters.pel.value = ''; ui.filters.subsetor.value = ''; populateAllFilters(); });
        ui.filters.pel.addEventListener('change', () => { ui.filters.subsetor.value = ''; populateAllFilters(); });

    </script>
</body>

</html>